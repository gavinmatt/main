---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout sideBarActiveItemID="flight-tracker" customTitle="What's Overhead?">

  <!-- HEADER -->
  <div class="text-5xl font-bold text-center mt-6">
    Live air traffic near Whitefish, MT
  </div>

  <p class="text-center py-4 max-w-3xl mx-auto">
    All data is captured from my home ADS-B antenna setup and reflects only aircraft
    my local receiver can hear (not aggregated radar data).
    <a href="/blog/flight-tracking" class="underline">Learn more</a>.
  </p>

  <!-- RADAR -->
  <div class="flex justify-center">
    <iframe
      src="https://globe.adsbexchange.com/?feed=dzxvAzrTfUSY&hideSidebar&zoom=7&lat=48.415&lon=-114.459"
      width="800"
      height="600"
      frameborder="0"
    ></iframe>
  </div>

  <!-- STATUS -->
  <p id="lastUpdated" class="text-center text-sm text-gray-500 mt-3"></p>

  <!-- TABLE -->
  <table class="w-full mt-6 text-sm border-collapse">
    <thead>
      <tr class="border-b">
        <th class="text-left">Airline</th>
        <th class="text-left">Callsign</th>
        <th class="text-left">ICAO</th>
        <th class="text-right">Altitude (ft)</th>
        <th class="text-right">Speed (kt)</th>
        <th class="text-right">Track</th>
        <th class="text-right">Last Seen (s)</th>
      </tr>
    </thead>
    <tbody id="flightBody"></tbody>
  </table>

  <!-- SCRIPT -->
  <script type="module">
    const tbody = document.getElementById('flightBody');
    const lastUpdatedEl = document.getElementById('lastUpdated');

    let lastGoodFlights = [];
    let lastReceivedAt = 0;

    // ICAO airline/operator → full name (US + common intl)
    const AIRLINE_NAMES = {
      AAL: "American Airlines",
      DAL: "Delta Air Lines",
      UAL: "United Airlines",
      ASA: "Alaska Airlines",
      SWA: "Southwest Airlines",
      NKS: "Spirit Airlines",
      FFT: "Frontier Airlines",
      JBU: "JetBlue Airways",
      AWE: "Widerøe Airline",
      ACA: "Air Canada",
      AFR: "Air France",
      BAW: "British Airways",
      DLH: "Lufthansa",
      KLM: "KLM Royal Dutch Airlines",
      QFA: "Qantas",
      UAE: "Emirates",
      ETD: "Etihad Airways",
      THY: "Turkish Airlines",
      ANA: "All Nippon Airways",
      JAL: "Japan Airlines",
      KAL: "Korean Air",
      CPA: "Cathay Pacific",
      SIA: "Singapore Airlines",
      AIC: "Air India",
      ACW: "Air Canada Rouge",
      WJA: "WestJet",
      IBK: "Iberia",
      VIR: "Virgin Atlantic",
      VRD: "Virgin America",
      UAL: "United Airlines",
      UPS: "UPS Airlines",
      FDX: "FedEx Express",
      GTI: "Air Italy",
      TOM: "TOM Airline",
      QTR: "Qatar Airways",
      AZA: "Alitalia",
      CSA: "Czech Airlines",
      LOT: "LOT Polish Airlines",
      SAS: "Scandinavian Airlines",
      FIN: "Finnair",
      TAP: "TAP Portugal",
      AUA: "Austrian Airlines",
      S7S: "S7 Airlines",
      AFL: "AirBridgeCargo",
      FXE: "Federal Express Europe",
      DLH: "Lufthansa",
      UAL: "United Airlines"    };

    function airlineFromFlight(f) {
      // Prefer full operator name if present
      if (f.op && f.op.trim()) {
        return f.op.trim();
      }

      // Fallback: callsign ICAO prefix
      const prefix = f.flight?.trim().match(/^[A-Z]{2,3}/)?.[0];
      if (prefix && AIRLINE_NAMES[prefix]) {
        return AIRLINE_NAMES[prefix];
      }

      return "—";
    }

    function render(flights) {
      tbody.innerHTML = flights.map(f => `
        <tr class="border-b">
          <td>${airlineFromFlight(f)}</td>
          <td>${f.flight?.trim() || '—'}</td>
          <td>${f.hex || '—'}</td>
          <td class="text-right">${f.alt_baro ?? f.alt_geom ?? '—'}</td>
          <td class="text-right">${f.gs ?? '—'}</td>
          <td class="text-right">${f.track ?? '—'}</td>
          <td class="text-right">${f.seen ?? '—'}</td>
        </tr>
      `).join('');
    }

    async function updateFlights() {
      try {
        const res = await fetch('/api/flights');
        if (res.status === 204) return;

        const data = await res.json();
        const flights = data.aircraft ?? [];

        if (flights.length) {
          lastGoodFlights = flights;
          lastReceivedAt = data.receivedAt;
          render(lastGoodFlights);
        }

        const age = Date.now() - lastReceivedAt;
        lastUpdatedEl.textContent =
          'Last updated ' +
          new Date(lastReceivedAt).toLocaleTimeString() +
          (age > 30000 ? ' (stale)' : '');
      } catch {
        // ignore transient errors
      }
    }

    updateFlights();
    setInterval(updateFlights, 10000);
  </script>

</BaseLayout>
