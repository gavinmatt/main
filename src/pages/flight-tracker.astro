---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout sideBarActiveItemID="flight-tracker" customTitle="What's Overhead?">
  <div class="text-5xl font-bold text-center">
    Live air traffic near Whitefish, MT
  </div>

  <p class="text-center py-4">
    All data is captured from my home ADS-B antenna setup.
    <a href="/blog/flight-tracking">Learn more</a>.
  </p>

  <div class="flex justify-center">
    <iframe
      src="https://globe.adsbexchange.com/?feed=dzxvAzrTfUSY&hideSidebar&zoom=7&lat=48.415&lon=-114.459"
      width="800"
      height="600"
      frameborder="0"
    ></iframe>
  </div>

  <p id="lastUpdated" class="text-center text-sm text-gray-500 mt-3"></p>

  <table class="w-full mt-4 text-sm">
    <thead>
      <tr class="border-b">
        <th>Airline</th>
        <th>Callsign</th>
        <th>ICAO</th>
        <th class="text-right">Altitude (ft)</th>
        <th class="text-right">Speed (kt)</th>
        <th class="text-right">Track</th>
        <th class="text-right">Last Seen (s)</th>
      </tr>
    </thead>
    <tbody id="flightBody"></tbody>
  </table>

  <script type="module">
    const tbody = document.getElementById('flightBody');
    const lastUpdatedEl = document.getElementById('lastUpdated');

    let lastGoodFlights = [];
    let lastReceivedAt = 0;

    function airlineFromFlight(f) {
      if (f.op) return f.op;

      if (f.flight) {
        const prefix = f.flight.trim().match(/^[A-Z]{2,3}/);
        if (prefix) return prefix[0];
      }

      return '—';
    }

    function render(flights) {
      tbody.innerHTML = flights.map(f => `
        <tr class="border-b">
          <td>${airlineFromFlight(f)}</td>
          <td>${f.flight?.trim() || '—'}</td>
          <td>${f.hex || '—'}</td>
          <td class="text-right">${f.alt_baro ?? f.alt_geom ?? '—'}</td>
          <td class="text-right">${f.gs ?? '—'}</td>
          <td class="text-right">${f.track ?? '—'}</td>
          <td class="text-right">${f.seen ?? '—'}</td>
        </tr>
      `).join('');
    }

    async function updateFlights() {
      try {
        const res = await fetch('/api/flights');
        if (res.status === 204) return;

        const data = await res.json();
        const flights = data.aircraft ?? [];

        if (flights.length) {
          lastGoodFlights = flights;
          lastReceivedAt = data.receivedAt;
          render(lastGoodFlights);
        }

        const age = Date.now() - lastReceivedAt;
        lastUpdatedEl.textContent =
          'Last updated ' +
          new Date(lastReceivedAt).toLocaleTimeString() +
          (age > 30000 ? ' (stale)' : '');
      } catch {
        // ignore transient errors
      }
    }

    updateFlights();
    setInterval(updateFlights, 10000);
  </script>
</BaseLayout>
