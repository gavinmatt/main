---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout sideBarActiveItemID="flight-tracker" customTitle="What's Overhead?">
  <!-- HEADER -->
  <div class="text-5xl font-bold text-center mt-6">
    Live air traffic near Whitefish, MT
  </div>

  <p class="text-center py-4 max-w-3xl mx-auto">
    All data is captured from my home ADS-B antenna setup and reflects only
    aircraft my local receiver can hear (not aggregated radar data).
    <a href="/blog/flight-tracking" class="underline">Learn more</a>.
  </p>

  <!-- RADAR -->
  <div class="flex justify-center">
    <iframe
      src="https://globe.adsbexchange.com/?feed=dzxvAzrTfUSY&hideSidebar&hideButtons&hideStats&zoom=7&lat=48.415&lon=-114.459&rings"
      width="800"
      height="600"
      frameborder="0"></iframe>
  </div>

  <!-- TABLE HEADER -->
  <div class="text-center">
    <div class="text-3xl w-full font-bold mt-10 mb-3">What’s overhead?</div>
  </div>

  <p class="text-center mb-4">
    More data about the planes currently flying in reach of my antenna. “—” and
    missing values are expected as not all planes send comprehensive data and
    data is lost as range increases. The table will flag interesting or uncommon
    flights.
  </p>

  <!-- STATUS -->
  <p id="lastUpdated" class="text-center text-sm text-gray-500 mt-2 mb-4"></p>

  <!-- EMPTY STATE -->
  <div
    id="emptyState"
    class="hidden max-w-3xl mx-auto mt-8 mb-4 text-center border border-dashed rounded-lg py-10 px-6 text-gray-500"
  >
    <div class="text-xl font-semibold mb-2">No aircraft currently in range</div>
    <p class="text-sm">
      My receiver is online and listening, but there are no aircraft
      transmitting decodable ADS-B data within range right now.
    </p>
  </div>

  <!-- TABLE -->
  <div class="max-w-6xl mx-auto px-4 text-gray-900">
    <table class="w-full border-collapse text-base text-gray-900">
      <thead>
        <tr class="border-b text-gray-700">
          <th class="text-left py-2 px-3">Flag</th>
          <th class="text-left py-2 px-3">Airline</th>
          <th class="text-left py-2 px-3">Callsign</th>
          <th class="text-left py-2 px-3">Class</th>
          <th class="text-left py-2 px-3">ICAO</th>
          <th class="text-right py-2 px-3">Altitude (ft)</th>
          <th class="text-right py-2 px-3">Speed (kt)</th>
          <th class="text-right py-2 px-3">Track</th>
          <th class="text-right py-2 px-3">Distance (NM)</th>
          <th class="text-right py-2 px-3">Last Seen (s)</th>
        </tr>
      </thead>
      <tbody id="flightBody" class="text-gray-900"></tbody>
    </table>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    const tbody = document.getElementById("flightBody");
    const emptyStateEl = document.getElementById("emptyState");
    const lastUpdatedEl = document.getElementById("lastUpdated");
    const STALE_AFTER_MS = 90_000;

    const RX_LAT = 48.415;
    const RX_LON = -114.459;

    function distanceNm(lat1, lon1, lat2, lon2) {
      const R = 3440.065;
      const toRad = (d) => (d * Math.PI) / 180;

      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);

      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) *
          Math.cos(toRad(lat2)) *
          Math.sin(dLon / 2) ** 2;

      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function aircraftDistance(f) {
      if (f.lat == null || f.lon == null) return null;
      return distanceNm(RX_LAT, RX_LON, f.lat, f.lon);
    }

    function distanceFlag(d) {
      if (d > 250)
        return { label: "EXTREME", cls: "bg-purple-100 text-purple-800" };
      if (d > 200)
        return { label: "LONG-RANGE", cls: "bg-indigo-100 text-indigo-800" };
      if (d > 150)
        return { label: "DISTANT", cls: "bg-blue-100 text-blue-800" };
      return null;
    }

    /* ---------- AIRLINE LOOKUP ---------- */

    const AIRLINE_NAMES = {
      AAL: "American Airlines",
      DAL: "Delta Air Lines",
      UAL: "United Airlines",
      ASA: "Alaska Airlines",
      SWA: "Southwest Airlines",
      JBU: "JetBlue Airways",
      NKS: "Spirit Airlines",
      FFT: "Frontier Airlines",

      ACA: "Air Canada",
      WJA: "WestJet",
      TSC: "Air Transat",
      SWG: "Sunwing",

      UPS: "UPS Airlines",
      FDX: "FedEx Express",
      GTI: "Atlas Air",
      CKS: "Kalitta Air",
      ABX: "ABX Air",
      POE: "Polar Air Cargo",
      CLX: "Cargolux",
      MNB: "ASL Airlines Belgium",
      EGG: "Western Global Airlines",

      BAW: "British Airways",
      DLH: "Lufthansa",
      KLM: "KLM Royal Dutch Airlines",
      AFR: "Air France",
      SAS: "Scandinavian Airlines",
      FIN: "Finnair",
      IBE: "Iberia",
      TAP: "TAP Air Portugal",
      LOT: "LOT Polish Airlines",
      AUA: "Austrian Airlines",
      SWR: "SWISS",
      EIN: "Aer Lingus",
      CFG: "Condor",
      ICE: "Icelandair",

      ANA: "All Nippon Airways",
      JAL: "Japan Airlines",
      KAL: "Korean Air",
      CPA: "Cathay Pacific",
      EVA: "EVA Air",
      CAL: "China Airlines",

      UAE: "Emirates",
      QTR: "Qatar Airways",
      ETD: "Etihad Airways",
      SVA: "Saudia",
      THY: "Turkish Airlines",

      ETH: "Ethiopian Airlines",
      RAM: "Royal Air Maroc",

      JAS: "Janus Airways",
      AEL: "AirExplore",
      BCS: "DHL Air",
      EWG: "Eurowings",
      TUI: "TUI Airways",
    };

    const COMMON_AIRLINES = new Set([
      "American Airlines",
      "Delta Air Lines",
      "United Airlines",
      "Alaska Airlines",
      "Southwest Airlines",
      "JetBlue Airways",
      "Spirit Airlines",
      "Frontier Airlines",
      "Air Canada",
      "WestJet",
      "FedEx Express",
      "UPS Airlines",
    ]);

    function airlineFromFlight(f) {
      if (f.op?.trim()) return f.op.trim();
      const prefix = f.flight?.trim().match(/^[A-Z]{2,3}/)?.[0];
      return AIRLINE_NAMES[prefix] || "—";
    }

    function isAirlineFlight(f) {
      return /^[A-Z]{2,3}\d/.test(f.flight || "");
    }

    function isStale(f) {
      return typeof f.seen === "number" && f.seen > STALE_AFTER_MS / 1000;
    }

    function aircraftClass(f) {
      if (f.category) return f.category;
      if (f.hex?.startsWith("AE")) return "MIL";
      return "—";
    }

    function classifyNotability(f) {
      if (f.hex?.startsWith("AE"))
        return { label: "MIL", cls: "bg-red-100 text-red-800" };

      const airline = airlineFromFlight(f);
      const airlinePattern = isAirlineFlight(f);

      if (airlinePattern && !COMMON_AIRLINES.has(airline))
        return { label: "UNCOMMON", cls: "bg-blue-100 text-blue-800" };

      if ((f.alt_baro ?? 0) > 45000 || (f.gs ?? 0) > 550)
        return { label: "FAST/HIGH", cls: "bg-yellow-100 text-yellow-800" };

      return null;
    }

    function secondsSinceSeen(f) {
      if (typeof f.seen === "number") return Math.round(f.seen);
      return "—";
    }

    function render(flights) {
      const activeFlights = flights
        .filter((f) => !isStale(f))
        .sort((a, b) => {
          const da = aircraftDistance(a);
          const db = aircraftDistance(b);
          return (db ?? 0) - (da ?? 0);
        });

      if (!activeFlights.length) {
        tbody.innerHTML = "";
        emptyStateEl.classList.remove("hidden");
        return;
      }

      emptyStateEl.classList.add("hidden");

      tbody.innerHTML = activeFlights
        .map((f) => {
          const note = classifyNotability(f);
          const d = aircraftDistance(f);
          const dFlag = d != null ? distanceFlag(d) : null;

          return `
          <tr class="border-b text-gray-900">
            <td class="py-2 px-3 space-x-1">
              ${note ? `<span class="px-2 py-0.5 rounded text-xs font-medium ${note.cls}">${note.label}</span>` : ""}
              ${dFlag ? `<span class="px-2 py-0.5 rounded text-xs font-medium ${dFlag.cls}">${dFlag.label}</span>` : ""}
            </td>
            <td class="py-2 px-3">${airlineFromFlight(f)}</td>
            <td class="py-2 px-3">${f.flight?.trim() || "—"}</td>
            <td class="py-2 px-3">${aircraftClass(f)}</td>
            <td class="py-2 px-3">${f.hex || "—"}</td>
            <td class="text-right py-2 px-3">${f.alt_baro ?? f.alt_geom ?? "—"}</td>
            <td class="text-right py-2 px-3">${f.gs ?? "—"}</td>
            <td class="text-right py-2 px-3">${f.track ?? "—"}</td>
            <td class="text-right py-2 px-3">${d != null ? Math.round(d) : "—"}</td>
            <td class="text-right py-2 px-3">${secondsSinceSeen(f)}</td>
          </tr>
        `;
        })
        .join("");
    }

    async function updateFlights() {
      try {
        const res = await fetch("/api/flights");
        if (res.status === 204) return;

        const data = await res.json();
        render(data.aircraft ?? []);

        lastUpdatedEl.textContent =
          "Last updated " + new Date(data.receivedAt).toLocaleTimeString();
      } catch {}
    }

    updateFlights();
    setInterval(updateFlights, 10000);
  </script>
</BaseLayout>
