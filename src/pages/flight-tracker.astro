---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout sideBarActiveItemID="flight-tracker" customTitle="What's Overhead?">

  <!-- HEADER -->
  <div class="text-5xl font-bold text-center mt-6">
    Live air traffic near Whitefish, MT
  </div>

  <p class="text-center py-4 max-w-3xl mx-auto">
    All data is captured from my home ADS-B antenna setup and reflects only aircraft
    my local receiver can hear (not aggregated radar data).
    <a href="/blog/flight-tracking" class="underline">Learn more</a>.
  </p>

  <!-- RADAR -->
  <div class="flex justify-center">
    <iframe
      src="https://globe.adsbexchange.com/?feed=dzxvAzrTfUSY&hideSidebar&zoom=7&lat=48.415&lon=-114.459"
      width="800"
      height="600"
      frameborder="0"
    ></iframe>
  </div>

  <div class="text-center">
    <div class="text-3xl w-full font-bold mb-5 mt-10">
      What's overhead?
    </div>
  </div>
  
  <p class="text-center">
    More data about the planes currently flying in reach of my antenna! "—" and missing data are expected - not all planes send a full array of flight data.
  </p>  

  <!-- STATUS -->
  <p id="lastUpdated" class="text-center text-sm text-gray-500 mt-3"></p>

  <!-- TABLE -->
  <table class="w-full mt-6 text-sm border-collapse">
    <thead>
      <tr class="border-b">
        <th class="text-left">Flag</th>
        <th class="text-left">Airline</th>
        <th class="text-left">Callsign</th>
        <th class="text-left">Class</th>
        <th class="text-left">ICAO</th>
        <th class="text-right">Altitude (ft)</th>
        <th class="text-right">Speed (kt)</th>
        <th class="text-right">Track</th>
        <th class="text-right">Last Seen (s)</th>
      </tr>
    </thead>
    <tbody id="flightBody"></tbody>
  </table>

  <!-- SCRIPT -->
  <script type="module">
    const tbody = document.getElementById('flightBody');
    const lastUpdatedEl = document.getElementById('lastUpdated');

    let lastGoodFlights = [];
    let lastReceivedAt = 0;

    // Airline/operator → full name
    const AIRLINE_NAMES = {
      AAL: "American Airlines",
      DAL: "Delta Air Lines",
      UAL: "United Airlines",
      ASA: "Alaska Airlines",
      SWA: "Southwest Airlines",
      JBU: "JetBlue Airways",
      NKS: "Spirit Airlines",
      FFT: "Frontier Airlines",
      ACA: "Air Canada",
      WJA: "WestJet",
      UPS: "UPS Airlines",
      FDX: "FedEx Express",
      GTI: "Atlas Air",
      CKS: "Kalitta Air",
      ABX: "ABX Air",
      AFR: "Air France",
      BAW: "British Airways",
      DLH: "Lufthansa",
      KLM: "KLM Royal Dutch Airlines",
      QTR: "Qatar Airways",
      UAE: "Emirates",
      THY: "Turkish Airlines",
      ANA: "All Nippon Airways",
      JAL: "Japan Airlines"
    };

    // Airlines that should NEVER be flagged as "uncommon" here
    const COMMON_AIRLINES = new Set([
      "United Airlines",
      "Delta Air Lines",
      "American Airlines",
      "Alaska Airlines",
      "Southwest Airlines",
      "JetBlue Airways",
      "Spirit Airlines",
      "Frontier Airlines",
      "Air Canada",
      "WestJet",
      "FedEx Express",
      "UPS Airlines",
      "Atlas Air",
      "Kalitta Air",
      "ABX Air"
    ]);

    function airlineFromFlight(f) {
      if (f.op && f.op.trim()) return f.op.trim();
      const prefix = f.flight?.trim().match(/^[A-Z]{2,3}/)?.[0];
      return AIRLINE_NAMES[prefix] || "—";
    }

    function aircraftClass(f) {
  if (f.category) return f.category;
  if (f.hex?.startsWith("AE")) return "MIL";
  return "—";
}

    /* -------- NOTABILITY LOGIC -------- */

    function isMilitary(f) {
      return (
        f.hex?.startsWith("AE") ||
        /^(RCH|QID|PAT|VM|NAVY)/.test(f.flight || "") ||
        /air force|navy|usaf|army/i.test(f.op || "")
      );
    }

    function isRareType(f) {
  return /^(B52|B1|B2|U2|E3|E6|E4B|KC|C17|C5|GLF|GLEX)/i.test(f.t || f.type || "");
}


    function isHighPerformance(f) {
      return (f.alt_baro ?? 0) > 45000 || (f.gs ?? 0) > 550;
    }

    function classifyNotability(f) {
      const airline = airlineFromFlight(f);

      if (isMilitary(f))
        return { label: "MIL", cls: "bg-red-100 text-red-800" };

      if (isRareType(f))
        return { label: "RARE", cls: "bg-purple-100 text-purple-800" };

      if (airline !== "—" && !COMMON_AIRLINES.has(airline))
        return { label: "UNCOMMON", cls: "bg-blue-100 text-blue-800" };

      if (isHighPerformance(f))
        return { label: "FAST/HIGH", cls: "bg-yellow-100 text-yellow-800" };

      return null;
    }

    function render(flights) {
      tbody.innerHTML = flights.map(f => {
        const note = classifyNotability(f);

        return `
          <tr class="border-b">
            <td>
              ${
                note
                  ? `<span class="px-2 py-0.5 rounded text-xs font-medium ${note.cls}">
                       ${note.label}
                     </span>`
                  : ""
              }
            </td>
            <td>${airlineFromFlight(f)}</td>
            <td>${f.flight?.trim() || "—"}</td>
            <td>${aircraftClass(f)}</td>
            <td>${f.hex || "—"}</td>
            <td class="text-right">${f.alt_baro ?? f.alt_geom ?? "—"}</td>
            <td class="text-right">${f.gs ?? "—"}</td>
            <td class="text-right">${f.track ?? "—"}</td>
            <td class="text-right">${f.seen ?? "—"}</td>
          </tr>
        `;
      }).join("");
    }

    async function updateFlights() {
      try {
        const res = await fetch("/api/flights");
        if (res.status === 204) return;

        const data = await res.json();
        const flights = data.aircraft ?? [];

        if (flights.length) {
          lastGoodFlights = flights;
          lastReceivedAt = data.receivedAt;
          render(lastGoodFlights);
        }

        const age = Date.now() - lastReceivedAt;
        lastUpdatedEl.textContent =
          "Last updated " +
          new Date(lastReceivedAt).toLocaleTimeString() +
          (age > 30000 ? " (refresh incoming)" : "");
      } catch {
        // ignore transient errors
      }
    }

    updateFlights();
    setInterval(updateFlights, 10000);
  </script>

</BaseLayout>
