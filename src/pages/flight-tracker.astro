---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout sideBarActiveItemID="flight-tracker" customTitle="What's Overhead?">

  <!-- HEADER -->
  <div class="text-5xl font-bold text-center mt-6">
    Live air traffic near Whitefish, MT
  </div>

  <p class="text-center py-4 max-w-3xl mx-auto">
    All data is captured from my home ADS-B antenna setup and reflects only aircraft
    my local receiver can hear (not aggregated radar data).
    <a href="/blog/flight-tracking" class="underline">Learn more</a>.
  </p>

  <!-- RADAR -->
  <div class="flex justify-center">
    <iframe
      src="https://globe.adsbexchange.com/?feed=dzxvAzrTfUSY&hideSidebar&hideButtons&hideStats&zoom=7&lat=48.415&lon=-114.459&rings"
      width="800"
      height="600"
      frameborder="0"
    ></iframe>
  </div>

  <!-- TABLE HEADER -->
  <div class="text-center">
    <div class="text-3xl w-full font-bold mt-10 mb-3">
      What’s overhead?
    </div>
  </div>

  <p class="text-center mb-4">
    More data about the planes currently flying in reach of my antenna.
    “—” and missing values are expected as not all planes send comprehensive data and data is lost as range increases. The table fades in color the older the data, and will flag interesting or uncommon flights.
  </p>

  <!-- STATUS -->
  <p id="lastUpdated" class="text-center text-sm text-gray-500 mt-2 mb-4"></p>

  <!-- TABLE -->
  <div class="max-w-6xl mx-auto px-4">
    <table class="w-full border-collapse text-base">
      <thead>
        <tr class="border-b text-gray-700">
          <th class="text-left py-2 px-3">Flag</th>
          <th class="text-left py-2 px-3">Airline</th>
          <th class="text-left py-2 px-3">Callsign</th>
          <th class="text-left py-2 px-3">Class</th>
          <th class="text-left py-2 px-3">ICAO</th>
          <th class="text-right py-2 px-3">Altitude (ft)</th>
          <th class="text-right py-2 px-3">Speed (kt)</th>
          <th class="text-right py-2 px-3">Track</th>
          <th class="text-right py-2 px-3">Last Seen (s)</th>
        </tr>
      </thead>
      <tbody id="flightBody"></tbody>
    </table>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    const tbody = document.getElementById("flightBody");
    const lastUpdatedEl = document.getElementById("lastUpdated");

    let lastReceivedAt = 0;
    let hasRenderedOnce = false;

    /* ---------- AIRLINE LOOKUP ---------- */

    const AIRLINE_NAMES = {
      AAL: "American Airlines",
      DAL: "Delta Air Lines",
      UAL: "United Airlines",
      ASA: "Alaska Airlines",
      SWA: "Southwest Airlines",
      JBU: "JetBlue Airways",
      NKS: "Spirit Airlines",
      FFT: "Frontier Airlines",
      ACA: "Air Canada",
      WJA: "WestJet",
      UPS: "UPS Airlines",
      FDX: "FedEx Express",
      GTI: "Atlas Air",
      CKS: "Kalitta Air",
      ABX: "ABX Air"
    };

    const COMMON_AIRLINES = new Set(Object.values(AIRLINE_NAMES));

    function airlineFromFlight(f) {
      if (f.op?.trim()) return f.op.trim();
      const prefix = f.flight?.trim().match(/^[A-Z]{2,3}/)?.[0];
      return AIRLINE_NAMES[prefix] || "—";
    }

    function aircraftClass(f) {
      if (f.category) return f.category;
      if (f.hex?.startsWith("AE")) return "MIL";
      return "—";
    }

    /* ---------- NOTABILITY ---------- */

    function classifyNotability(f) {
      if (f.hex?.startsWith("AE"))
        return { label: "MIL", cls: "bg-red-100 text-red-800" };

      const airline = airlineFromFlight(f);
      if (airline !== "—" && !COMMON_AIRLINES.has(airline))
        return { label: "UNCOMMON", cls: "bg-blue-100 text-blue-800" };

      if ((f.alt_baro ?? 0) > 45000 || (f.gs ?? 0) > 550)
        return { label: "FAST/HIGH", cls: "bg-yellow-100 text-yellow-800" };

      return null;
    }

    /* ---------- ROW AGING (COLOR-BASED, NOT OPACITY) ---------- */

    function rowClass(f) {
      if (!hasRenderedOnce) return "text-gray-900";
      const ageMs = Date.now() - (f.lastSeenAt || 0);
      if (ageMs > 90000) return "text-gray-400";
      if (ageMs > 45000) return "text-gray-600";
      return "text-gray-900";
    }

    function secondsSinceSeen(f) {
      return f.lastSeenAt
        ? Math.round((Date.now() - f.lastSeenAt) / 1000)
        : "—";
    }

    function render(flights) {
      tbody.innerHTML = flights.map(f => {
        const note = classifyNotability(f);

        return `
          <tr class="border-b transition-colors duration-500 ${rowClass(f)}">
            <td class="py-2 px-3">
              ${
                note
                  ? `<span class="px-2 py-0.5 rounded text-xs font-medium ${note.cls}">
                       ${note.label}
                     </span>`
                  : ""
              }
            </td>
            <td class="py-2 px-3">${airlineFromFlight(f)}</td>
            <td class="py-2 px-3">${f.flight?.trim() || "—"}</td>
            <td class="py-2 px-3">${aircraftClass(f)}</td>
            <td class="py-2 px-3">${f.hex || "—"}</td>
            <td class="text-right py-2 px-3">${f.alt_baro ?? f.alt_geom ?? "—"}</td>
            <td class="text-right py-2 px-3">${f.gs ?? "—"}</td>
            <td class="text-right py-2 px-3">${f.track ?? "—"}</td>
            <td class="text-right py-2 px-3">${secondsSinceSeen(f)}</td>
          </tr>
        `;
      }).join("");

      hasRenderedOnce = true;
    }

    async function updateFlights() {
      try {
        const res = await fetch("/api/flights");
        if (res.status === 204) return;

        const data = await res.json();
        render(data.aircraft ?? []);

        lastReceivedAt = data.receivedAt;
        lastUpdatedEl.textContent =
          "Last updated " + new Date(lastReceivedAt).toLocaleTimeString();
      } catch {
        // silent retry
      }
    }

    updateFlights();
    setInterval(updateFlights, 10000);
  </script>

</BaseLayout>
