---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout sideBarActiveItemID="flight-tracker" customTitle="What's Overhead?">

  <div class="text-5xl font-bold" style="text-align: center;">
    Live air traffic near Whitefish, MT
  </div>

  <p style="text-align: center; padding-top: 20px; padding-bottom: 20px;">
    All data is captured from my home ADS-B antenna setup, feeding to providers
    including Flightradar24, ADS-B Exchange, and FlightAware.
    Want to try this yourself?
    <a href="https://www.gavmatt.com/blog/flight-tracking">Learn more</a>.
  </p>

  <div style="display: flex; justify-content: center;">
    <iframe
      src="https://globe.adsbexchange.com/?feed=dzxvAzrTfUSY&hideSidebar&rangeRings=1&hideButtons&zoom=7&lat=48.415&lon=-114.459"
      width="800"
      height="600"
      frameborder="0"
      style="border: 0;"
    ></iframe>
  </div>

  <!-- BEGIN local ADS-B flight table -->
  <div style="max-width: 1000px; margin: 50px auto 0 auto;">
    <h2 class="text-3xl font-bold" style="text-align:center; margin-bottom: 10px;">
      Aircraft currently received by my antenna
    </h2>

    <p style="text-align:center; color:#666; margin-bottom: 20px;">
      Live data from my local ADS-B receiver (updates every 10 seconds)
    </p>

    <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
      <thead>
        <tr style="background:#f5f5f5;">
          <th style="padding:.4rem; text-align:left;">Callsign</th>
          <th style="padding:.4rem; text-align:left;">ICAO</th>
          <th style="padding:.4rem; text-align:right;">Altitude (ft)</th>
          <th style="padding:.4rem; text-align:right;">Speed (kt)</th>
          <th style="padding:.4rem; text-align:right;">Track</th>
          <th style="padding:.4rem; text-align:right;">Last Seen (s)</th>
        </tr>
      </thead>
      <tbody id="flightBody">
        <tr>
          <td colspan="6" style="padding:.4rem;">Loading…</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    const tbody = document.getElementById('flightBody');

    async function updateFlights() {
      try {
        const res = await fetch('/api/flights', { cache: 'no-store' });

        if (res.status === 204) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="padding:.4rem;">No flights detected.</td></tr>';
          return;
        }

        if (!res.ok) {
          throw new Error('Bad response');
        }

        const data = await res.json();
        const flights = data.aircraft || [];

        if (!flights.length) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="padding:.4rem;">No flights detected.</td></tr>';
          return;
        }

        tbody.innerHTML = flights.map(f => `
          <tr>
            <td style="border-bottom:1px solid #eee;padding:.4rem;">
              ${f.flight || '—'}
            </td>
            <td style="border-bottom:1px solid #eee;padding:.4rem;">
              ${f.hex || '—'}
            </td>
            <td style="border-bottom:1px solid #eee;padding:.4rem; text-align:right;">
              ${f.altitude ?? '—'}
            </td>
            <td style="border-bottom:1px solid #eee;padding:.4rem; text-align:right;">
              ${f.speed ?? '—'}
            </td>
            <td style="border-bottom:1px solid #eee;padding:.4rem; text-align:right;">
              ${f.track ?? '—'}
            </td>
            <td style="border-bottom:1px solid #eee;padding:.4rem; text-align:right;">
              ${f.seen ?? '—'}
            </td>
          </tr>
        `).join('');
      } catch {
        tbody.innerHTML =
          '<tr><td colspan="6" style="padding:.4rem;">Error loading local feed.</td></tr>';
      }
    }

    updateFlights();
    setInterval(updateFlights, 10000);
  </script>
  <!-- END local ADS-B flight table -->

</BaseLayout>
