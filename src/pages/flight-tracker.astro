---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout
  sideBarActiveItemID="flight-tracker"
  customTitle="Flight Tracker"
  description="Live ADS-B aircraft tracking from a personal antenna in northwest Montana. View current overhead flights and the furthest-away aircraft ever received."
  canonical="https://www.gavmatt.com/flight-tracker"
  ogImage="https://www.gavmatt.com/flight-tracker.png"
>
  <!-- HEADER -->
  <div class="text-5xl font-bold text-center mt-6">
    Live air traffic near Whitefish, MT
  </div>

  <p class="text-center py-4 max-w-3xl mx-auto">
    All data is captured from my home ADS-B antenna setup and reflects only
    aircraft my local receiver can hear (not aggregated radar data).
    <a href="/blog/flight-tracking" class="underline">Learn more</a>.
  </p>

  <!-- RADAR -->
  <div class="flex justify-center">
    <iframe
      src="https://globe.adsbexchange.com/?feed=dzxvAzrTfUSY&hideSidebar&hideButtons&hideStats&zoom=7&lat=48.415&lon=-114.459&rings"
      width="800"
      height="600"
      frameborder="0"></iframe>
  </div>

  <!-- TABLE HEADER -->
  <div class="text-center">
    <div class="text-3xl w-full font-bold mt-10 mb-3">What‚Äôs overhead?</div>
  </div>

  <p class="text-center mb-4">
    More data about the planes currently flying in reach of my antenna. ‚Äú‚Äî‚Äù and
    missing values are expected as not all planes send comprehensive data and
    data is lost as range increases. The table will flag interesting or uncommon
    flights.
  </p>

  <!-- STATUS -->
  <p id="lastUpdated" class="text-center text-sm text-gray-500 mt-2 mb-4"></p>

  <!-- EMPTY STATE -->
  <div
    id="emptyState"
    class="hidden max-w-3xl mx-auto mt-8 mb-4 text-center border border-dashed rounded-lg py-10 px-6 text-gray-500"
  >
    <div class="text-xl font-semibold mb-2">No aircraft currently in range</div>
    <p class="text-sm">
      My receiver is online and listening, but there are no aircraft
      transmitting decodable ADS-B data within range right now.
    </p>
  </div>

  <!-- TABLE -->
  <div class="max-w-6xl mx-auto px-4 text-gray-900">
    <table class="w-full border-collapse text-base text-gray-900">
      <thead>
        <tr class="border-b text-gray-700">
          <th class="text-left py-2 px-3">Interesting?</th>
          <th class="text-left py-2 px-3">Airline</th>
          <th class="text-left py-2 px-3">Callsign</th>
          <th class="text-left py-2 px-3">Type</th>
          <th class="text-left py-2 px-3">ICAO</th>
          <th class="text-right py-2 px-3">Altitude (ft)</th>
          <th class="text-right py-2 px-3">Speed (kt)</th>
          <th class="text-right py-2 px-3">Track</th>
          <th class="text-right py-2 px-3">Distance (NM)</th>
          <th class="text-right py-2 px-3">Last Seen (s)</th>
        </tr>
      </thead>
      <tbody id="flightBody" class="text-gray-900"></tbody>
    </table>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    const tbody = document.getElementById("flightBody");
    const emptyStateEl = document.getElementById("emptyState");
    const lastUpdatedEl = document.getElementById("lastUpdated");
    const STALE_AFTER_MS = 90_000;

    const RX_LAT = 48.415;
    const RX_LON = -114.459;

    function distanceNm(lat1, lon1, lat2, lon2) {
      const R = 3440.065;
      const toRad = (d) => (d * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function aircraftDistance(f) {
      if (f.lat == null || f.lon == null) return null;
      return distanceNm(RX_LAT, RX_LON, f.lat, f.lon);
    }

    function distanceFlag(d) {
      if (d > 250)
        return { label: "EXTREME", cls: "bg-purple-100 text-purple-800" };
      if (d > 200)
        return { label: "LONG-RANGE", cls: "bg-indigo-100 text-indigo-800" };
      if (d > 150)
        return { label: "DISTANT", cls: "bg-blue-100 text-blue-800" };
      return null;
    }

    function notableLabelForFlight(f) {
      // 1Ô∏è‚É£ Authoritative: ICAO hex block
      if (hexUpper(f).startsWith("AE")) {
        return "USAF";
      }

      // 2Ô∏è‚É£ Callsign-based military (fallback)
      const cs = callsignRaw(f);
      if (/^(ENRGY|QID|TEX|GOLD|NACHO|RCH|REACH|MC|AMC)/.test(cs)) {
        return "USAF";
      }

      // 3Ô∏è‚É£ Otherwise fall through to airline / normal logic
      return airlineFromFlight(f);
    }

    function notableDistanceLabel(d) {
      if (d >= 250) {
        return { label: "AMAZING", cls: "bg-purple-100 text-purple-800" };
      }
      if (d >= 180) {
        return { label: "GREAT", cls: "bg-indigo-100 text-indigo-800" };
      }
      if (d >= 120) {
        return { label: "GOOD", cls: "bg-blue-100 text-blue-800" };
      }
      return null;
    }

    function renderNotables(rows) {
      const notableBody = document.getElementById("notableBody");
      if (!notableBody) return;

      if (!rows || !rows.length) {
        notableBody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center py-6 text-gray-500">
          No notable pings recorded yet.
        </td>
      </tr>
    `;
        return;
      }

      const medals = ["ü•á", "ü•à", "ü•â"];

      notableBody.innerHTML = rows
        .map((r, i) => {
          const fakeFlight = { flight: r.callsign };
          const rank = medals[i] ?? "";
          const label = notableDistanceLabel(r.maxDistance);

          return `
      <tr class="border-b">
        <td class="text-center py-2 px-3 text-xl">${rank}</td>
        <td class="text-center py-2 px-3">
  ${
    label
      ? `<span class="px-2 py-0.5 rounded text-xs font-medium ${label.cls}">
          ${label.label}
        </span>`
      : "‚Äî"
  }
</td>

<td class="py-2 px-3">
  ${
    r.airline && r.airline !== "‚Äî"
      ? r.airline
      : notableLabelForFlight(fakeFlight)
  }
</td>

        <td class="py-2 px-3">${r.callsign}</td>        
        <td class="text-right py-2 px-3 font-semibold">${r.maxDistance}</td>
        <td class="text-right py-2 px-3">
          ${new Date(r.lastSeen).toLocaleDateString()}
        </td>
      </tr>
    `;
        })
        .join("");
    }

    async function loadNotables() {
      const notableBody = document.getElementById("notableBody");
      if (!notableBody) return;

      try {
        const res = await fetch("/api/notable-pings");
        const data = await res.json();
        renderNotables(data.rows ?? []);
      } catch {}
    }

    /* ---------- AIRLINE LOOKUP ---------- */

    const AIRLINE_NAMES = {
      AAL: "American Airlines",
      DAL: "Delta Air Lines",
      UAL: "United Airlines",
      ASA: "Alaska Airlines",
      SWA: "Southwest Airlines",
      JBU: "JetBlue Airways",
      NKS: "Spirit Airlines",
      FFT: "Frontier Airlines",
      SKW: "SkyWest Airlines",

      ACA: "Air Canada",
      ROU: "Air Canada Rouge",
      WJA: "WestJet",
      WEN: "WestJet Encore",
      TSC: "Air Transat",
      SWG: "Sunwing",
      FLE: "Flair Airlines",
      QXE: "Horizon Air",
      JZA: "Jazz",
      CNK: "Sunwest Aviation",
      LXJ: "Flexjet",
      VIR: "Virgin Atlantic",

      UPS: "UPS Airlines",
      FDX: "FedEx Express",
      GTI: "Atlas Air",
      CKS: "Kalitta Air",
      ABX: "ABX Air",
      POE: "Polar Air Cargo",
      CLX: "Cargolux",
      MNB: "ASL Airlines Belgium",
      EGG: "Western Global Airlines",
      MAL: "Morningstar Air",
      CJT: "Cargojet",
      ATN: "Air Transport International",
      CFS: "Empire Airlines",
      AAY: "Allegiant",

      BAW: "British Airways",
      DLH: "Lufthansa",
      KLM: "KLM Royal Dutch Airlines",
      AFR: "Air France",
      SAS: "Scandinavian Airlines",
      FIN: "Finnair",
      IBE: "Iberia",
      TAP: "TAP Air Portugal",
      LOT: "LOT Polish Airlines",
      AUA: "Austrian Airlines",
      SWR: "SWISS",
      EIN: "Aer Lingus",
      CFG: "Condor",
      ICE: "Icelandair",
      FBU: "French Bee",

      ANA: "All Nippon Airways",
      JAL: "Japan Airlines",
      KAL: "Korean Air",
      CPA: "Cathay Pacific",
      EVA: "EVA Air",
      CAL: "China Airlines",

      UAE: "Emirates",
      QQE: "Qatar Executive",
      QTR: "Qatar Airways",
      ETD: "Etihad Airways",
      SVA: "Saudia",
      THY: "Turkish Airlines",
      IFA: "Fai Airservice",
      HRT: "Chartright Air",

      ETH: "Ethiopian Airlines",
      RAM: "Royal Air Maroc",

      JAS: "Janus Airways",
      AEL: "AirExplore",
      BCS: "DHL Air",
      EWG: "Eurowings",
      TUI: "TUI Airways",

      ASP: "AirSprint",
      AIP: "Alpine Aviation",
      EJA: "NetJets",
      AMF: "Ameriflight",
      VJA: "VistaAmerica",
      AJI: "Ameristar Jet Charter",
      TWY: "Sunset Aviation",
    };

    const COMMON_AIRLINES = new Set([
      "American Airlines",
      "Delta Air Lines",
      "United Airlines",
      "Alaska Airlines",
      "Southwest Airlines",
      "JetBlue Airways",
      "Spirit Airlines",
      "Frontier Airlines",
      "Air Canada",
      "Air Canada Rouge",
      "WestJet",
      "WestJet Encore",
      "FedEx Express",
      "UPS Airlines",
      "Flair Airlines",
      "Horizon Air",
      "Cargojet",
      "Air Transport International",
      "SkyWest Airlines",
      "Sunwest Aviation",
      "Empire Airlines",
      "Alpine Aviation",
      "NetJets",
      "Ameriflight",
      "VistaAmerica",
      "Allegiant",
      "Ameristar Jet Charter",
      "Chartright Air",
      "Sunset Aviation",
    ]);

    function callsignRaw(f) {
      const cs = (f.flight || f.callsign || "").trim().toUpperCase();
      if (!cs || cs === "00000000") return "";
      return cs;
    }

    function isUnknownAirline(f) {
      const cs = callsignRaw(f);
      if (!cs) return false;

      // Airline-style callsign (2‚Äì3 letters + digits)
      const looksLikeAirline = /^[A-Z]{2,3}\d/.test(cs);
      if (!looksLikeAirline) return false;

      const prefix = cs.match(/^[A-Z]{2,3}/)?.[0];
      return !AIRLINE_NAMES[prefix];
    }

    function isPrivateFlight(f) {
      const cs = callsignRaw(f);
      if (!cs) return false; // ‚Üê critical change

      return (
        // US
        /^N\d{1,5}[A-Z]{0,2}$/.test(cs) ||
        // Canada
        /^C-?[FG][A-Z]{3}$/.test(cs) ||
        // UK
        /^G-?[A-Z]{4}$/.test(cs) ||
        // Germany
        /^D-?[A-Z]{4}$/.test(cs) ||
        // Switzerland
        /^HB-?[A-Z]{3}$/.test(cs)
      );
    }

    function isAirlineFlight(f) {
      const cs = callsignRaw(f);
      return /^[A-Z]{2,3}\d/.test(cs);
    }

    function isHelicopter(f) {
      return f.category === "A7";
    }

    function airlineFromFlight(f) {
      const cs = callsignRaw(f);

      // ‚úÖ Boeing test / delivery flights
      if (/^BOE\d+/.test(cs)) return "Boeing Test Flight";

      // Explicit private registration
      if (isPrivateFlight(f)) return "Private";

      // Known operator (even if callsign missing)
      if (f.op?.trim()) return f.op.trim();

      // Airline-style callsign but not yet resolved
      if (!cs) return "Undetermined";

      const prefix = cs.match(/^[A-Z]{2,3}/)?.[0];
      return AIRLINE_NAMES[prefix] || "‚Äî";
    }

    function isStale(f) {
      return typeof f.seen === "number" && f.seen > STALE_AFTER_MS / 1000;
    }

    const ICAO_TYPE_MAP = {};

    function hexUpper(f) {
      return f.hex?.toUpperCase() ?? "";
    }

    function aircraftType(f) {
      // Helicopters
      if (f.category === "A7") return "Helicopter";

      // Military ICAO allocation
      if (hexUpper(f).startsWith("AE")) return "Military";

      // Category-only classification (authoritative for dump1090-fa)
      switch (f.category) {
        case "A5":
          return "Heavy Jet";
        case "A3":
          return "Large Jet";
        case "A2":
          return "Turboprop";
        case "A1":
          return "Light Aircraft";
      }

      return "‚Äî";
    }

    /* ---------- MILITARY BRANCH ---------- */

    function militaryBranch(f) {
      const cs = callsignRaw(f);

      // ICAO allocation: US military (authoritative)
      if (hexUpper(f).startsWith("AE")) {
        // Tanker refinement (ENRGY, QID, TEX, etc.)
        if (
          /^(ENRGY|QID|TEX|GOLD|NACHO)/.test(cs) ||
          ((f.alt_baro ?? 0) > 30000 && (f.gs ?? 0) < 500)
        ) {
          return "USAF (TANKER)";
        }
        return "USAF";
      }

      // Callsign-based fallback (when hex is missing or delayed)
      if (/^(ENRGY|QID|TEX|GOLD|NACHO|RCH|REACH|MC|AMC)/.test(cs)) {
        return "USAF (TANKER)";
      }

      if (/^(NAVY|CNV|VV)/.test(cs)) return "USN";
      if (/^(PAT|ARMY)/.test(cs)) return "USA";
      if (/^(VM|MAR)/.test(cs)) return "USMC";

      return null;
    }

    function classifyNotability(f) {
      const cs = callsignRaw(f);

      // 1Ô∏è‚É£ Helicopters ‚Äî always special
      if (f.category === "A7") {
        return { label: "HELI", cls: "bg-emerald-100 text-emerald-800" };
      }

      // ‚úÖ Boeing test flights
      if (/^BOE\d+/.test(cs)) {
        return { label: "Test Flight", cls: "bg-amber-100 text-amber-800" };
      }

      // 2Ô∏è‚É£ Military (callsign or AE hex)
      const branch = militaryBranch(f);
      if (branch) {
        return {
          label: branch,
          cls: branch.includes("TANKER")
            ? "bg-red-200 text-red-900"
            : "bg-red-100 text-red-800",
        };
      }

      // 3Ô∏è‚É£ Uncommon airline
      const airline = airlineFromFlight(f);
      const airlinePattern = isAirlineFlight(f);

      if (airlinePattern && airline !== "‚Äî" && !COMMON_AIRLINES.has(airline)) {
        return { label: "UNCOMMON", cls: "bg-blue-100 text-blue-800" };
      }

      // 4Ô∏è‚É£ Performance-based oddities
      if ((f.alt_baro ?? 0) > 45000 || (f.gs ?? 0) > 550) {
        return { label: "FAST/HIGH", cls: "bg-yellow-100 text-yellow-800" };
      }

      return null;
    }

    function secondsSinceSeen(f) {
      if (typeof f.seen === "number") return Math.round(f.seen);
      return "‚Äî";
    }

    function callsignDisplay(f) {
      const cs = callsignRaw(f);
      return cs || "No callsign";
    }

    function render(flights) {
      const activeFlights = flights
        .filter((f) => !isStale(f))
        .sort((a, b) => {
          const da = aircraftDistance(a);
          const db = aircraftDistance(b);
          return (db ?? 0) - (da ?? 0);
        });

      if (!activeFlights.length) {
        tbody.innerHTML = "";
        emptyStateEl.classList.remove("hidden");
        return;
      }

      emptyStateEl.classList.add("hidden");

      tbody.innerHTML = activeFlights
        .map((f) => {
          if (isUnknownAirline(f)) {
            console.log("[UNKNOWN_AIRLINE]", {
              callsign: callsignRaw(f),
              hex: f.hex,
              alt: f.alt_baro ?? f.alt_geom,
              gs: f.gs,
              distance_nm: aircraftDistance(f),
              seen_s: f.seen,
            });
          }

          const note = classifyNotability(f);
          const d = aircraftDistance(f);
          const dFlag = d != null ? distanceFlag(d) : null;

          return `
        <tr class="border-b text-gray-900">
          <td class="py-2 px-3 space-x-1 text-gray-400">
            ${
              note || dFlag
                ? `
                  ${note ? `<span class="px-2 py-0.5 rounded text-xs font-medium ${note.cls}">${note.label}</span>` : ""}
                  ${dFlag ? `<span class="px-2 py-0.5 rounded text-xs font-medium ${dFlag.cls}">${dFlag.label}</span>` : ""}
                `
                : "‚Äî"
            }
          </td>
          <td class="py-2 px-3">${airlineFromFlight(f)}</td>
          <td class="py-2 px-3">${callsignDisplay(f)}</td>
          <td class="py-2 px-3">${aircraftType(f)}</td>
          <td class="py-2 px-3">${f.hex || "‚Äî"}</td>
          <td class="text-right py-2 px-3">${f.alt_baro ?? f.alt_geom ?? "‚Äî"}</td>
          <td class="text-right py-2 px-3">${f.gs ?? "‚Äî"}</td>
          <td class="text-right py-2 px-3">${f.track ?? "‚Äî"}</td>
          <td class="text-right py-2 px-3">${d != null ? Math.round(d) : "‚Äî"}</td>
          <td class="text-right py-2 px-3">${secondsSinceSeen(f)}</td>
        </tr>
      `;
        })
        .join("");
    }

    async function updateFlights() {
      try {
        const res = await fetch("/api/flights");
        if (res.status === 204) return;
        const data = await res.json();
        render(data.aircraft ?? []);
        lastUpdatedEl.textContent =
          "Last updated " + new Date(data.receivedAt).toLocaleTimeString();
      } catch {}
    }

    updateFlights();
    setInterval(updateFlights, 10000);

    loadNotables();
  </script>

  <!-- NOTABLE PINGS -->
  <div class="max-w-6xl mx-auto px-4 mt-20">
    <div class="text-3xl font-bold mb-4 text-center">Distant pings</div>

    <p class="text-center mb-4">
      Furthest away aircraft I've tracked. 1 NM = ~1.15 miles for a crow.
    </p>
    <p class="text-center mb-4">
      Good = 120-180NM, great = 180-250NM, and amazing = 250+NM for my setup.
    </p>

    <table class="w-full border-collapse text-base text-gray-900">
      <thead>
        <tr class="border-b text-gray-700">
          <th class="text-center py-2 px-3">Ranking</th>
          <th class="text-center py-2 px-3">Distance Rating</th>
          <th class="text-left py-2 px-3">Airline</th>
          <th class="text-left py-2 px-3">Callsign</th>
          <th class="text-right py-2 px-3">Max Distance (NM)</th>
          <th class="text-right py-2 px-3">Last Seen</th>
        </tr>
      </thead>
      <tbody id="notableBody"></tbody>
    </table>
  </div>
</BaseLayout>
